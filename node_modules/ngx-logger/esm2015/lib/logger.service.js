/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpHeaders, HttpParams } from '@angular/common/http';
import { NGXLoggerHttpService } from './http.service';
import { NgxLoggerLevel } from './types/logger-level.enum';
import { LoggerConfig } from './logger.config';
import { NGXLoggerConfigEngine } from './config.engine';
import { NGXLoggerUtils } from './utils/logger.utils';
import { NGXMapperService } from './mapper.service';
/** @type {?} */
export const Levels = [
    'TRACE',
    'DEBUG',
    'INFO',
    'LOG',
    'WARN',
    'ERROR',
    'FATAL',
    'OFF'
];
export class NGXLogger {
    /**
     * @param {?} mapperService
     * @param {?} httpService
     * @param {?} loggerConfig
     */
    constructor(mapperService, httpService, loggerConfig) {
        this.mapperService = mapperService;
        this.httpService = httpService;
        this._withCredentials = false;
        this._isIE = navigator && navigator.userAgent &&
            !!(navigator.userAgent.indexOf('MSIE') !== -1 || navigator.userAgent.match(/Trident\//) || navigator.userAgent.match(/Edge\//));
        // each instance of the logger should have their own config engine
        this.config = new NGXLoggerConfigEngine(loggerConfig);
        this._logFunc = this._isIE ? this._logIE.bind(this) : this._logModern.bind(this);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    trace(message, ...additional) {
        this._log(NgxLoggerLevel.TRACE, message, additional);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    debug(message, ...additional) {
        this._log(NgxLoggerLevel.DEBUG, message, additional);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    info(message, ...additional) {
        this._log(NgxLoggerLevel.INFO, message, additional);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    log(message, ...additional) {
        this._log(NgxLoggerLevel.LOG, message, additional);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    warn(message, ...additional) {
        this._log(NgxLoggerLevel.WARN, message, additional);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    error(message, ...additional) {
        this._log(NgxLoggerLevel.ERROR, message, additional);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    fatal(message, ...additional) {
        this._log(NgxLoggerLevel.FATAL, message, additional);
    }
    /**
     * @param {?} headers
     * @return {?}
     */
    setCustomHttpHeaders(headers) {
        this._customHttpHeaders = headers;
    }
    /**
     * @param {?} params
     * @return {?}
     */
    setCustomParams(params) {
        this._customParams = params;
    }
    /**
     * @param {?} withCredentials
     * @return {?}
     */
    setWithCredentialsOptionValue(withCredentials) {
        this._withCredentials = withCredentials;
    }
    /**
     * @param {?} monitor
     * @return {?}
     */
    registerMonitor(monitor) {
        this._loggerMonitor = monitor;
    }
    /**
     * @param {?} config
     * @return {?}
     */
    updateConfig(config) {
        this.config.updateConfig(config);
    }
    /**
     * @return {?}
     */
    getConfigSnapshot() {
        return this.config.getConfig();
    }
    /**
     * @private
     * @param {?} level
     * @param {?} metaString
     * @param {?} message
     * @param {?} additional
     * @return {?}
     */
    _logIE(level, metaString, message, additional) {
        // Coloring doesn't work in IE
        // make sure additional isn't null or undefined so that ...additional doesn't error
        additional = additional || [];
        switch (level) {
            case NgxLoggerLevel.WARN:
                console.warn(`${metaString} `, message, ...additional);
                break;
            case NgxLoggerLevel.ERROR:
            case NgxLoggerLevel.FATAL:
                console.error(`${metaString} `, message, ...additional);
                break;
            case NgxLoggerLevel.INFO:
                console.info(`${metaString} `, message, ...additional);
                break;
            default:
                console.log(`${metaString} `, message, ...additional);
        }
    }
    /**
     * @private
     * @param {?} level
     * @param {?} metaString
     * @param {?} message
     * @param {?} additional
     * @return {?}
     */
    _logModern(level, metaString, message, additional) {
        /** @type {?} */
        const color = NGXLoggerUtils.getColor(level);
        // make sure additional isn't null or undefined so that ...additional doesn't error
        additional = additional || [];
        switch (level) {
            case NgxLoggerLevel.WARN:
                console.warn(`%c${metaString}`, `color:${color}`, message, ...additional);
                break;
            case NgxLoggerLevel.ERROR:
            case NgxLoggerLevel.FATAL:
                console.error(`%c${metaString}`, `color:${color}`, message, ...additional);
                break;
            case NgxLoggerLevel.INFO:
                console.info(`%c${metaString}`, `color:${color}`, message, ...additional);
                break;
            //  Disabling console.trace since the stack trace is not helpful. it is showing the stack trace of
            // the console.trace statement
            // case NgxLoggerLevel.TRACE:
            //   console.trace(`%c${metaString}`, `color:${color}`, message, ...additional);
            //   break;
            //  Disabling console.debug, because Has this hidden by default.
            // case NgxLoggerLevel.DEBUG:
            //   console.debug(`%c${metaString}`, `color:${color}`, message, ...additional);
            //   break;
            default:
                console.log(`%c${metaString}`, `color:${color}`, message, ...additional);
        }
    }
    /**
     * @private
     * @param {?} level
     * @param {?} message
     * @param {?=} additional
     * @param {?=} logOnServer
     * @return {?}
     */
    _log(level, message, additional = [], logOnServer = true) {
        /** @type {?} */
        const config = this.config.getConfig();
        /** @type {?} */
        const isLog2Server = logOnServer && config.serverLoggingUrl && level >= config.serverLogLevel;
        /** @type {?} */
        const isLogLevelEnabled = level >= config.level;
        if (!(message && (isLog2Server || isLogLevelEnabled))) {
            return;
        }
        /** @type {?} */
        const logLevelString = Levels[level];
        message = NGXLoggerUtils.prepareMessage(message);
        // only use validated parameters for HTTP requests
        /** @type {?} */
        const validatedAdditionalParameters = NGXLoggerUtils.prepareAdditionalParameters(additional);
        /** @type {?} */
        const timestamp = new Date().toISOString();
        // const callerDetails = NGXLoggerUtils.getCallerDetails();
        this.mapperService.getCallerDetails(config.enableSourceMaps).subscribe((/**
         * @param {?} callerDetails
         * @return {?}
         */
        (callerDetails) => {
            /** @type {?} */
            const logObject = {
                message: message,
                additional: validatedAdditionalParameters,
                level: level,
                timestamp: timestamp,
                fileName: callerDetails.fileName,
                lineNumber: callerDetails.lineNumber.toString()
            };
            if (this._loggerMonitor && isLogLevelEnabled) {
                this._loggerMonitor.onLog(logObject);
            }
            if (isLog2Server) {
                // make sure the stack gets sent to the server
                message = message instanceof Error ? message.stack : message;
                logObject.message = message;
                /** @type {?} */
                const headers = this._customHttpHeaders || new HttpHeaders();
                headers.set('Content-Type', 'application/json');
                /** @type {?} */
                const options = {
                    headers: headers,
                    params: this._customParams || new HttpParams(),
                    responseType: config.httpResponseType || 'json',
                    withCredentials: this._withCredentials
                };
                // Allow logging on server even if client log level is off
                this.httpService.logOnServer(config.serverLoggingUrl, logObject, options).subscribe((/**
                 * @param {?} res
                 * @return {?}
                 */
                (res) => {
                    // I don't think we should do anything on success
                }), (/**
                 * @param {?} error
                 * @return {?}
                 */
                (error) => {
                    this._log(NgxLoggerLevel.ERROR, `FAILED TO LOG ON SERVER: ${message}`, [error], false);
                }));
            }
            // if no message or the log level is less than the environ
            if (isLogLevelEnabled && !config.disableConsoleLogging) {
                /** @type {?} */
                const metaString = NGXLoggerUtils.prepareMetaString(timestamp, logLevelString, callerDetails.fileName, callerDetails.lineNumber.toString());
                return this._logFunc(level, metaString, message, additional);
            }
        }));
    }
}
NGXLogger.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NGXLogger.ctorParameters = () => [
    { type: NGXMapperService },
    { type: NGXLoggerHttpService },
    { type: LoggerConfig }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype._isIE;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype._logFunc;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype.config;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype._customHttpHeaders;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype._customParams;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype._withCredentials;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype._loggerMonitor;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype.mapperService;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype.httpService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtbG9nZ2VyLyIsInNvdXJjZXMiOlsibGliL2xvZ2dlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQVUsVUFBVSxFQUFlLE1BQU0sZUFBZSxDQUFDO0FBQ2hFLE9BQU8sRUFBcUIsV0FBVyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBR2xGLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXRELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDeEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBR3RELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDOztBQUVwRCxNQUFNLE9BQU8sTUFBTSxHQUFHO0lBQ3BCLE9BQU87SUFDUCxPQUFPO0lBQ1AsTUFBTTtJQUNOLEtBQUs7SUFDTCxNQUFNO0lBQ04sT0FBTztJQUNQLE9BQU87SUFDUCxLQUFLO0NBQ047QUFJRCxNQUFNLE9BQU8sU0FBUzs7Ozs7O0lBVXBCLFlBQTZCLGFBQStCLEVBQW1CLFdBQWlDLEVBQ3BHLFlBQTBCO1FBRFQsa0JBQWEsR0FBYixhQUFhLENBQWtCO1FBQW1CLGdCQUFXLEdBQVgsV0FBVyxDQUFzQjtRQUp4RyxxQkFBZ0IsR0FBWSxLQUFLLENBQUM7UUFNeEMsSUFBSSxDQUFDLEtBQUssR0FBRyxTQUFTLElBQUksU0FBUyxDQUFDLFNBQVM7WUFDM0MsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksU0FBUyxDQUFDLFNB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QUFDLGdCQUFnQixFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQyxTQUFTOzs7O2dCQUFDLENBQUMsR0FBUSxFQUFFLEVBQUU7b0JBQzdGLGlEQUFpRDtnQkFDbkQsQ0FBQzs7OztnQkFDRCxDQUFDLEtBQXdCLEVBQUUsRUFBRTtvQkFDM0IsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLDRCQUE0QixPQUFPLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUN6RixDQUFDLEVBQ0YsQ0FBQzthQUNIO1lBR0QsMERBQTBEO1lBQzFELElBQUksaUJBQWlCLElBQUksQ0FBQyxNQUFNLENBQUMscUJBQXFCLEVBQUU7O3NCQUNoRCxVQUFVLEdBQUcsY0FBYyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsRUFBRSxjQUFjLEVBQzNFLGFBQWEsQ0FBQyxRQUFRLEVBQUUsYUFBYSxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFFOUQsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFDO2FBQzlEO1FBQ0gsQ0FBQyxFQUFDLENBQUM7SUFDTCxDQUFDOzs7WUFwTUYsVUFBVTs7OztZQWRGLGdCQUFnQjtZQVJoQixvQkFBb0I7WUFHcEIsWUFBWTs7Ozs7OztJQXFCbkIsMEJBQWdDOzs7OztJQUNoQyw2QkFBb0M7Ozs7O0lBQ3BDLDJCQUFzQzs7Ozs7SUFDdEMsdUNBQXdDOzs7OztJQUN4QyxrQ0FBa0M7Ozs7O0lBQ2xDLHFDQUEwQzs7Ozs7SUFFMUMsbUNBQXlDOzs7OztJQUU3QixrQ0FBZ0Q7Ozs7O0lBQUUsZ0NBQWtEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBQTEFURk9STV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cEVycm9yUmVzcG9uc2UsIEh0dHBIZWFkZXJzLCBIdHRwUGFyYW1zIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuXG5pbXBvcnQgeyBOR1hMb2dnZXJIdHRwU2VydmljZSB9IGZyb20gJy4vaHR0cC5zZXJ2aWNlJztcbmltcG9ydCB7TG9nUG9zaXRpb259IGZyb20gJy4vdHlwZXMvbG9nLXBvc2l0aW9uJztcbmltcG9ydCB7IE5neExvZ2dlckxldmVsIH0gZnJvbSAnLi90eXBlcy9sb2dnZXItbGV2ZWwuZW51bSc7XG5pbXBvcnQgeyBMb2dnZXJDb25maWcgfSBmcm9tICcuL2xvZ2dlci5jb25maWcnO1xuaW1wb3J0IHsgTkdYTG9nZ2VyQ29uZmlnRW5naW5lIH0gZnJvbSAnLi9jb25maWcuZW5naW5lJztcbmltcG9ydCB7IE5HWExvZ2dlclV0aWxzIH0gZnJvbSAnLi91dGlscy9sb2dnZXIudXRpbHMnO1xuaW1wb3J0IHsgTkdYTG9nZ2VyTW9uaXRvciB9IGZyb20gJy4vbG9nZ2VyLW1vbml0b3InO1xuaW1wb3J0IHsgTkdYTG9nSW50ZXJmYWNlIH0gZnJvbSAnLi90eXBlcy9uZ3gtbG9nLmludGVyZmFjZSc7XG5pbXBvcnQgeyBOR1hNYXBwZXJTZXJ2aWNlIH0gZnJvbSAnLi9tYXBwZXIuc2VydmljZSc7XG5cbmV4cG9ydCBjb25zdCBMZXZlbHMgPSBbXG4gICdUUkFDRScsXG4gICdERUJVRycsXG4gICdJTkZPJyxcbiAgJ0xPRycsXG4gICdXQVJOJyxcbiAgJ0VSUk9SJyxcbiAgJ0ZBVEFMJyxcbiAgJ09GRidcbl07XG5cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5HWExvZ2dlciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgX2lzSUU6IGJvb2xlYW47XG4gIHByaXZhdGUgcmVhZG9ubHkgX2xvZ0Z1bmM6IEZ1bmN0aW9uO1xuICBwcml2YXRlIGNvbmZpZzogTkdYTG9nZ2VyQ29uZmlnRW5naW5lO1xuICBwcml2YXRlIF9jdXN0b21IdHRwSGVhZGVyczogSHR0cEhlYWRlcnM7XG4gIHByaXZhdGUgX2N1c3RvbVBhcmFtczogSHR0cFBhcmFtcztcbiAgcHJpdmF0ZSBfd2l0aENyZWRlbnRpYWxzOiBib29sZWFuID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSBfbG9nZ2VyTW9uaXRvcjogTkdYTG9nZ2VyTW9uaXRvcjtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IG1hcHBlclNlcnZpY2U6IE5HWE1hcHBlclNlcnZpY2UsIHByaXZhdGUgcmVhZG9ubHkgaHR0cFNlcnZpY2U6IE5HWExvZ2dlckh0dHBTZXJ2aWNlLFxuICAgICAgICAgICAgICBsb2dnZXJDb25maWc6IExvZ2dlckNvbmZpZykge1xuICAgIHRoaXMuX2lzSUUgPSBuYXZpZ2F0b3IgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudCAmJlxuICAgICAgISEobmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCdNU0lFJykgIT09IC0xIHx8IG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL1RyaWRlbnRcXC8vKSB8fCBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9FZGdlXFwvLykpO1xuXG4gICAgLy8gZWFjaCBpbnN0YW5jZSBvZiB0aGUgbG9nZ2VyIHNob3VsZCBoYXZlIHRoZWlyIG93biBjb25maWcgZW5naW5lXG4gICAgdGhpcy5jb25maWcgPSBuZXcgTkdYTG9nZ2VyQ29uZmlnRW5naW5lKGxvZ2dlckNvbmZpZyk7XG5cbiAgICB0aGlzLl9sb2dGdW5jID0gdGhpcy5faXNJRSA/IHRoaXMuX2xvZ0lFLmJpbmQodGhpcykgOiB0aGlzLl9sb2dNb2Rlcm4uYmluZCh0aGlzKTtcblxuICB9XG5cbiAgcHVibGljIHRyYWNlKG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWw6IGFueVtdKTogdm9pZCB7XG4gICAgdGhpcy5fbG9nKE5neExvZ2dlckxldmVsLlRSQUNFLCBtZXNzYWdlLCBhZGRpdGlvbmFsKTtcbiAgfVxuXG4gIHB1YmxpYyBkZWJ1ZyhtZXNzYWdlLCAuLi5hZGRpdGlvbmFsOiBhbnlbXSk6IHZvaWQge1xuICAgIHRoaXMuX2xvZyhOZ3hMb2dnZXJMZXZlbC5ERUJVRywgbWVzc2FnZSwgYWRkaXRpb25hbCk7XG4gIH1cblxuICBwdWJsaWMgaW5mbyhtZXNzYWdlLCAuLi5hZGRpdGlvbmFsOiBhbnlbXSk6IHZvaWQge1xuICAgIHRoaXMuX2xvZyhOZ3hMb2dnZXJMZXZlbC5JTkZPLCBtZXNzYWdlLCBhZGRpdGlvbmFsKTtcbiAgfVxuXG4gIHB1YmxpYyBsb2cobWVzc2FnZSwgLi4uYWRkaXRpb25hbDogYW55W10pOiB2b2lkIHtcbiAgICB0aGlzLl9sb2coTmd4TG9nZ2VyTGV2ZWwuTE9HLCBtZXNzYWdlLCBhZGRpdGlvbmFsKTtcbiAgfVxuXG4gIHB1YmxpYyB3YXJuKG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWw6IGFueVtdKTogdm9pZCB7XG4gICAgdGhpcy5fbG9nKE5neExvZ2dlckxldmVsLldBUk4sIG1lc3NhZ2UsIGFkZGl0aW9uYWwpO1xuICB9XG5cbiAgcHVibGljIGVycm9yKG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWw6IGFueVtdKTogdm9pZCB7XG4gICAgdGhpcy5fbG9nKE5neExvZ2dlckxldmVsLkVSUk9SLCBtZXNzYWdlLCBhZGRpdGlvbmFsKTtcbiAgfVxuXG4gIHB1YmxpYyBmYXRhbChtZXNzYWdlLCAuLi5hZGRpdGlvbmFsOiBhbnlbXSk6IHZvaWQge1xuICAgIHRoaXMuX2xvZyhOZ3hMb2dnZXJMZXZlbC5GQVRBTCwgbWVzc2FnZSwgYWRkaXRpb25hbCk7XG4gIH1cblxuICBwdWJsaWMgc2V0Q3VzdG9tSHR0cEhlYWRlcnMoaGVhZGVyczogSHR0cEhlYWRlcnMpIHtcbiAgICB0aGlzLl9jdXN0b21IdHRwSGVhZGVycyA9IGhlYWRlcnM7XG4gIH1cblxuICBwdWJsaWMgc2V0Q3VzdG9tUGFyYW1zKHBhcmFtczogSHR0cFBhcmFtcykge1xuICAgIHRoaXMuX2N1c3RvbVBhcmFtcyA9IHBhcmFtcztcbiAgfVxuXG4gIHB1YmxpYyBzZXRXaXRoQ3JlZGVudGlhbHNPcHRpb25WYWx1ZSh3aXRoQ3JlZGVudGlhbHM6IGJvb2xlYW4pIHtcbiAgICB0aGlzLl93aXRoQ3JlZGVudGlhbHMgPSB3aXRoQ3JlZGVudGlhbHM7XG4gIH1cblxuICBwdWJsaWMgcmVnaXN0ZXJNb25pdG9yKG1vbml0b3I6IE5HWExvZ2dlck1vbml0b3IpIHtcbiAgICB0aGlzLl9sb2dnZXJNb25pdG9yID0gbW9uaXRvcjtcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVDb25maWcoY29uZmlnOiBMb2dnZXJDb25maWcpIHtcbiAgICB0aGlzLmNvbmZpZy51cGRhdGVDb25maWcoY29uZmlnKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25maWdTbmFwc2hvdCgpOiBMb2dnZXJDb25maWcge1xuICAgIHJldHVybiB0aGlzLmNvbmZpZy5nZXRDb25maWcoKTtcbiAgfVxuXG4gIHByaXZhdGUgX2xvZ0lFKGxldmVsOiBOZ3hMb2dnZXJMZXZlbCwgbWV0YVN0cmluZzogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcsIGFkZGl0aW9uYWw6IGFueVtdKTogdm9pZCB7XG5cbiAgICAvLyBDb2xvcmluZyBkb2Vzbid0IHdvcmsgaW4gSUVcbiAgICAvLyBtYWtlIHN1cmUgYWRkaXRpb25hbCBpc24ndCBudWxsIG9yIHVuZGVmaW5lZCBzbyB0aGF0IC4uLmFkZGl0aW9uYWwgZG9lc24ndCBlcnJvclxuICAgIGFkZGl0aW9uYWwgPSBhZGRpdGlvbmFsIHx8IFtdO1xuXG4gICAgc3dpdGNoIChsZXZlbCkge1xuICAgICAgY2FzZSBOZ3hMb2dnZXJMZXZlbC5XQVJOOlxuICAgICAgICBjb25zb2xlLndhcm4oYCR7bWV0YVN0cmluZ30gYCwgbWVzc2FnZSwgLi4uYWRkaXRpb25hbCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBOZ3hMb2dnZXJMZXZlbC5FUlJPUjpcbiAgICAgIGNhc2UgTmd4TG9nZ2VyTGV2ZWwuRkFUQUw6XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYCR7bWV0YVN0cmluZ30gYCwgbWVzc2FnZSwgLi4uYWRkaXRpb25hbCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBOZ3hMb2dnZXJMZXZlbC5JTkZPOlxuICAgICAgICBjb25zb2xlLmluZm8oYCR7bWV0YVN0cmluZ30gYCwgbWVzc2FnZSwgLi4uYWRkaXRpb25hbCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgY29uc29sZS5sb2coYCR7bWV0YVN0cmluZ30gYCwgbWVzc2FnZSwgLi4uYWRkaXRpb25hbCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfbG9nTW9kZXJuKGxldmVsOiBOZ3hMb2dnZXJMZXZlbCwgbWV0YVN0cmluZzogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcsIGFkZGl0aW9uYWw6IGFueVtdKTogdm9pZCB7XG5cbiAgICBjb25zdCBjb2xvciA9IE5HWExvZ2dlclV0aWxzLmdldENvbG9yKGxldmVsKTtcblxuICAgIC8vIG1ha2Ugc3VyZSBhZGRpdGlvbmFsIGlzbid0IG51bGwgb3IgdW5kZWZpbmVkIHNvIHRoYXQgLi4uYWRkaXRpb25hbCBkb2Vzbid0IGVycm9yXG4gICAgYWRkaXRpb25hbCA9IGFkZGl0aW9uYWwgfHwgW107XG5cbiAgICBzd2l0Y2ggKGxldmVsKSB7XG4gICAgICBjYXNlIE5neExvZ2dlckxldmVsLldBUk46XG4gICAgICAgIGNvbnNvbGUud2FybihgJWMke21ldGFTdHJpbmd9YCwgYGNvbG9yOiR7Y29sb3J9YCwgbWVzc2FnZSwgLi4uYWRkaXRpb25hbCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBOZ3hMb2dnZXJMZXZlbC5FUlJPUjpcbiAgICAgIGNhc2UgTmd4TG9nZ2VyTGV2ZWwuRkFUQUw6XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYCVjJHttZXRhU3RyaW5nfWAsIGBjb2xvcjoke2NvbG9yfWAsIG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWwpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgTmd4TG9nZ2VyTGV2ZWwuSU5GTzpcbiAgICAgICAgY29uc29sZS5pbmZvKGAlYyR7bWV0YVN0cmluZ31gLCBgY29sb3I6JHtjb2xvcn1gLCBtZXNzYWdlLCAuLi5hZGRpdGlvbmFsKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICAvLyAgRGlzYWJsaW5nIGNvbnNvbGUudHJhY2Ugc2luY2UgdGhlIHN0YWNrIHRyYWNlIGlzIG5vdCBoZWxwZnVsLiBpdCBpcyBzaG93aW5nIHRoZSBzdGFjayB0cmFjZSBvZlxuICAgICAgLy8gdGhlIGNvbnNvbGUudHJhY2Ugc3RhdGVtZW50XG4gICAgICAvLyBjYXNlIE5neExvZ2dlckxldmVsLlRSQUNFOlxuICAgICAgLy8gICBjb25zb2xlLnRyYWNlKGAlYyR7bWV0YVN0cmluZ31gLCBgY29sb3I6JHtjb2xvcn1gLCBtZXNzYWdlLCAuLi5hZGRpdGlvbmFsKTtcbiAgICAgIC8vICAgYnJlYWs7XG5cbiAgICAgIC8vICBEaXNhYmxpbmcgY29uc29sZS5kZWJ1ZywgYmVjYXVzZSBIYXMgdGhpcyBoaWRkZW4gYnkgZGVmYXVsdC5cbiAgICAgIC8vIGNhc2UgTmd4TG9nZ2VyTGV2ZWwuREVCVUc6XG4gICAgICAvLyAgIGNvbnNvbGUuZGVidWcoYCVjJHttZXRhU3RyaW5nfWAsIGBjb2xvcjoke2NvbG9yfWAsIG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWwpO1xuICAgICAgLy8gICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGNvbnNvbGUubG9nKGAlYyR7bWV0YVN0cmluZ31gLCBgY29sb3I6JHtjb2xvcn1gLCBtZXNzYWdlLCAuLi5hZGRpdGlvbmFsKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9sb2cobGV2ZWw6IE5neExvZ2dlckxldmVsLCBtZXNzYWdlLCBhZGRpdGlvbmFsOiBhbnlbXSA9IFtdLCBsb2dPblNlcnZlcjogYm9vbGVhbiA9IHRydWUpOiB2b2lkIHtcbiAgICBjb25zdCBjb25maWcgPSB0aGlzLmNvbmZpZy5nZXRDb25maWcoKTtcbiAgICBjb25zdCBpc0xvZzJTZXJ2ZXIgPSBsb2dPblNlcnZlciAmJiBjb25maWcuc2VydmVyTG9nZ2luZ1VybCAmJiBsZXZlbCA+PSBjb25maWcuc2VydmVyTG9nTGV2ZWw7XG4gICAgY29uc3QgaXNMb2dMZXZlbEVuYWJsZWQgPSBsZXZlbCA+PSBjb25maWcubGV2ZWw7XG5cbiAgICBpZiAoIShtZXNzYWdlICYmIChpc0xvZzJTZXJ2ZXIgfHwgaXNMb2dMZXZlbEVuYWJsZWQpKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGxvZ0xldmVsU3RyaW5nID0gTGV2ZWxzW2xldmVsXTtcblxuICAgIG1lc3NhZ2UgPSBOR1hMb2dnZXJVdGlscy5wcmVwYXJlTWVzc2FnZShtZXNzYWdlKTtcblxuICAgIC8vIG9ubHkgdXNlIHZhbGlkYXRlZCBwYXJhbWV0ZXJzIGZvciBIVFRQIHJlcXVlc3RzXG4gICAgY29uc3QgdmFsaWRhdGVkQWRkaXRpb25hbFBhcmFtZXRlcnMgPSBOR1hMb2dnZXJVdGlscy5wcmVwYXJlQWRkaXRpb25hbFBhcmFtZXRlcnMoYWRkaXRpb25hbCk7XG5cbiAgICBjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG5cbiAgICAvLyBjb25zdCBjYWxsZXJEZXRhaWxzID0gTkdYTG9nZ2VyVXRpbHMuZ2V0Q2FsbGVyRGV0YWlscygpO1xuICAgIHRoaXMubWFwcGVyU2VydmljZS5nZXRDYWxsZXJEZXRhaWxzKGNvbmZpZy5lbmFibGVTb3VyY2VNYXBzKS5zdWJzY3JpYmUoKGNhbGxlckRldGFpbHM6IExvZ1Bvc2l0aW9uKSA9PiB7XG4gICAgICBjb25zdCBsb2dPYmplY3Q6IE5HWExvZ0ludGVyZmFjZSA9IHtcbiAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcbiAgICAgICAgYWRkaXRpb25hbDogdmFsaWRhdGVkQWRkaXRpb25hbFBhcmFtZXRlcnMsXG4gICAgICAgIGxldmVsOiBsZXZlbCxcbiAgICAgICAgdGltZXN0YW1wOiB0aW1lc3RhbXAsXG4gICAgICAgIGZpbGVOYW1lOiBjYWxsZXJEZXRhaWxzLmZpbGVOYW1lLFxuICAgICAgICBsaW5lTnVtYmVyOiBjYWxsZXJEZXRhaWxzLmxpbmVOdW1iZXIudG9TdHJpbmcoKVxuICAgICAgfTtcblxuICAgICAgaWYgKHRoaXMuX2xvZ2dlck1vbml0b3IgJiYgaXNMb2dMZXZlbEVuYWJsZWQpIHtcbiAgICAgICAgdGhpcy5fbG9nZ2VyTW9uaXRvci5vbkxvZyhsb2dPYmplY3QpO1xuICAgICAgfVxuXG4gICAgICBpZiAoaXNMb2cyU2VydmVyKSB7XG4gICAgICAgIC8vIG1ha2Ugc3VyZSB0aGUgc3RhY2sgZ2V0cyBzZW50IHRvIHRoZSBzZXJ2ZXJcbiAgICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UgaW5zdGFuY2VvZiBFcnJvciA/IG1lc3NhZ2Uuc3RhY2sgOiBtZXNzYWdlO1xuICAgICAgICBsb2dPYmplY3QubWVzc2FnZSA9IG1lc3NhZ2U7XG5cbiAgICAgICAgY29uc3QgaGVhZGVycyA9IHRoaXMuX2N1c3RvbUh0dHBIZWFkZXJzIHx8IG5ldyBIdHRwSGVhZGVycygpO1xuICAgICAgICBoZWFkZXJzLnNldCgnQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcblxuICAgICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnMsXG4gICAgICAgICAgcGFyYW1zOiB0aGlzLl9jdXN0b21QYXJhbXMgfHwgbmV3IEh0dHBQYXJhbXMoKSxcbiAgICAgICAgICByZXNwb25zZVR5cGU6IGNvbmZpZy5odHRwUmVzcG9uc2VUeXBlIHx8ICdqc29uJyxcbiAgICAgICAgICB3aXRoQ3JlZGVudGlhbHM6IHRoaXMuX3dpdGhDcmVkZW50aWFsc1xuICAgICAgICB9O1xuICAgICAgICAvLyBBbGxvdyBsb2dnaW5nIG9uIHNlcnZlciBldmVuIGlmIGNsaWVudCBsb2cgbGV2ZWwgaXMgb2ZmXG4gICAgICAgIHRoaXMuaHR0cFNlcnZpY2UubG9nT25TZXJ2ZXIoY29uZmlnLnNlcnZlckxvZ2dpbmdVcmwsIGxvZ09iamVjdCwgb3B0aW9ucykuc3Vic2NyaWJlKChyZXM6IGFueSkgPT4ge1xuICAgICAgICAgICAgLy8gSSBkb24ndCB0aGluayB3ZSBzaG91bGQgZG8gYW55dGhpbmcgb24gc3VjY2Vzc1xuICAgICAgICAgIH0sXG4gICAgICAgICAgKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fbG9nKE5neExvZ2dlckxldmVsLkVSUk9SLCBgRkFJTEVEIFRPIExPRyBPTiBTRVJWRVI6ICR7bWVzc2FnZX1gLCBbZXJyb3JdLCBmYWxzZSk7XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfVxuXG5cbiAgICAgIC8vIGlmIG5vIG1lc3NhZ2Ugb3IgdGhlIGxvZyBsZXZlbCBpcyBsZXNzIHRoYW4gdGhlIGVudmlyb25cbiAgICAgIGlmIChpc0xvZ0xldmVsRW5hYmxlZCAmJiAhY29uZmlnLmRpc2FibGVDb25zb2xlTG9nZ2luZykge1xuICAgICAgICBjb25zdCBtZXRhU3RyaW5nID0gTkdYTG9nZ2VyVXRpbHMucHJlcGFyZU1ldGFTdHJpbmcodGltZXN0YW1wLCBsb2dMZXZlbFN0cmluZyxcbiAgICAgICAgICBjYWxsZXJEZXRhaWxzLmZpbGVOYW1lLCBjYWxsZXJEZXRhaWxzLmxpbmVOdW1iZXIudG9TdHJpbmcoKSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2xvZ0Z1bmMobGV2ZWwsIG1ldGFTdHJpbmcsIG1lc3NhZ2UsIGFkZGl0aW9uYWwpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG59XG4iXX0=