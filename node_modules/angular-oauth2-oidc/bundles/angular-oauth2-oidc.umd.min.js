!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("rxjs"),require("rxjs/operators"),require("jsrsasign")):"function"==typeof define&&define.amd?define("angular-oauth2-oidc",["exports","@angular/core","@angular/common","@angular/common/http","rxjs","rxjs/operators","jsrsasign"],t):t((e=e||self)["angular-oauth2-oidc"]={},e.ng.core,e.ng.common,e.ng.common.http,e.rxjs,e.rxjs.operators,e.jsrsasign)}(this,function(e,t,r,n,o,i,s){"use strict";var a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function c(e,t){function r(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function u(e,t,r,n){return new(r||(r=Promise))(function(o,i){function s(e){try{c(n.next(e))}catch(t){i(t)}}function a(e){try{c(n["throw"](e))}catch(t){i(t)}}function c(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(s,a)}c((n=n.apply(e,t||[])).next())})}function h(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),"throw":a(1),"return":a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n["return"]:i[0]?n["throw"]||((o=n["return"])&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(a){i=[6,a],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function l(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function d(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(a){o={error:a}}finally{try{n&&!n.done&&(r=i["return"])&&r.call(i)}finally{if(o)throw o.error}}return s}var p=function(){return function(){this.preventClearHashAfterLogin=!1}}(),f=function(){return function(){}}(),g=function(){return function(){}}(),m=function(){return function(){}}();function v(e){var t=e.replace(/\-/g,"+").replace(/\_/g,"/");return decodeURIComponent(atob(t).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}function y(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}var k=function(){return function(){}}(),_=function(){function e(){}return e.prototype.validateAtHash=function(e){return u(this,void 0,void 0,function(){var t,r,n,o,i;return h(this,function(s){switch(s.label){case 0:return t=this.inferHashAlgorithm(e.idTokenHeader),[4,this.calcHash(e.accessToken,t)];case 1:return r=s.sent(),n=r.substr(0,r.length/2),o=y(n),i=e.idTokenClaims.at_hash.replace(/=/g,""),o!==i&&(console.error("exptected at_hash: "+o),console.error("actual at_hash: "+i)),[2,o===i]}})})},e.prototype.inferHashAlgorithm=function(e){var t=e.alg;if(!t.match(/^.S[0-9]{3}$/))throw new Error("Algorithm not supported: "+t);return"sha-"+t.substr(2)},e}(),w=function(){function e(){}return e.prototype.getHashFragmentParams=function(e){var t=e||window.location.hash;if(0!==(t=decodeURIComponent(t)).indexOf("#"))return{};var r=t.indexOf("?");return t=r>-1?t.substr(r+1):t.substr(1),this.parseQueryString(t)},e.prototype.parseQueryString=function(e){var t,r,n,o,i,s,a,c={};if(null===e)return c;t=e.split("&");for(var u=0;u<t.length;u++)-1===(n=(r=t[u]).indexOf("="))?(o=r,i=null):(o=r.substr(0,n),i=r.substr(n+1)),s=decodeURIComponent(o),a=decodeURIComponent(i),"/"===s.substr(0,1)&&(s=s.substr(1)),c[s]=a;return c},e.decorators=[{type:t.Injectable}],e}(),b=function(){return function(e){this.type=e}}(),S=function(e){function t(t,r){void 0===r&&(r=null);var n=e.call(this,t)||this;return n.info=r,n}return c(t,e),t}(b),T=function(e){function t(t,r){void 0===r&&(r=null);var n=e.call(this,t)||this;return n.info=r,n}return c(t,e),t}(b),I=function(e){function t(t,r,n){void 0===n&&(n=null);var o=e.call(this,t)||this;return o.reason=r,o.params=n,o}return c(t,e),t}(b),C=function(){return function(e){this.clientId="",this.redirectUri="",this.postLogoutRedirectUri="",this.loginUrl="",this.scope="openid profile",this.resource="",this.rngUrl="",this.oidc=!0,this.requestAccessToken=!0,this.options=null,this.issuer="",this.logoutUrl="",this.clearHashAfterLogin=!0,this.tokenEndpoint=null,this.userinfoEndpoint=null,this.responseType="",this.showDebugInformation=!1,this.silentRefreshRedirectUri="",this.silentRefreshMessagePrefix="",this.silentRefreshShowIFrame=!1,this.siletRefreshTimeout=2e4,this.silentRefreshTimeout=2e4,this.dummyClientSecret=null,this.requireHttps="remoteOnly",this.strictDiscoveryDocumentValidation=!0,this.jwks=null,this.customQueryParams=null,this.silentRefreshIFrameName="angular-oauth-oidc-silent-refresh-iframe",this.timeoutFactor=.75,this.sessionChecksEnabled=!1,this.sessionCheckIntervall=3e3,this.sessionCheckIFrameUrl=null,this.sessionCheckIFrameName="angular-oauth-oidc-check-session-iframe",this.disableAtHashCheck=!1,this.skipSubjectCheck=!1,this.useIdTokenHintForSilentRefresh=!1,this.skipIssuerCheck=!1,this.nonceStateSeparator=";",this.useHttpBasicAuth=!1,this.disablePKCE=!1,this.openUri=function(e){location.href=e},e&&Object.assign(this,e)}}(),A=function(){function e(){}return e.prototype.encodeKey=function(e){return encodeURIComponent(e)},e.prototype.encodeValue=function(e){return encodeURIComponent(e)},e.prototype.decodeKey=function(e){return decodeURIComponent(e)},e.prototype.decodeValue=function(e){return decodeURIComponent(e)},e}(),E=function(){return function(){}}(),j=function(e){function r(t,r,n,i,s,a,c,u){var h=e.call(this)||this;h.ngZone=t,h.http=r,h.config=s,h.urlHelper=a,h.logger=c,h.crypto=u,h.discoveryDocumentLoaded=!1,h.state="",h.eventsSubject=new o.Subject,h.discoveryDocumentLoadedSubject=new o.Subject,h.grantTypesSupported=[],h.inImplicitFlow=!1,h.debug("angular-oauth2-oidc v8-beta"),h.discoveryDocumentLoaded$=h.discoveryDocumentLoadedSubject.asObservable(),h.events=h.eventsSubject.asObservable(),i&&(h.tokenValidationHandler=i),s&&h.configure(s);try{n?h.setStorage(n):"undefined"!=typeof sessionStorage&&h.setStorage(sessionStorage)}catch(l){console.error("No OAuthStorage provided and cannot access default (sessionStorage).Consider providing a custom OAuthStorage implementation in your module.",l)}return h.setupRefreshTimer(),h}return c(r,e),r.prototype.configure=function(e){Object.assign(this,new C,e),this.config=Object.assign({},new C,e),this.sessionChecksEnabled&&this.setupSessionCheck(),this.configChanged()},r.prototype.configChanged=function(){this.setupRefreshTimer()},r.prototype.restartSessionChecksIfStillLoggedIn=function(){this.hasValidIdToken()&&this.initSessionCheck()},r.prototype.restartRefreshTimerIfStillLoggedIn=function(){this.setupExpirationTimers()},r.prototype.setupSessionCheck=function(){var e=this;this.events.pipe(i.filter(function(e){return"token_received"===e.type})).subscribe(function(t){e.initSessionCheck()})},r.prototype.setupAutomaticSilentRefresh=function(e,t,r){var n=this;void 0===e&&(e={}),void 0===r&&(r=!0);var o=!0;this.events.pipe(i.tap(function(e){"token_received"===e.type?o=!0:"logout"===e.type&&(o=!1)}),i.filter(function(e){return"token_expires"===e.type})).subscribe(function(i){null!=t&&"any"!==t&&i.info!==t||!o||n.refreshInternal(e,r)["catch"](function(e){n.debug("Automatic silent refresh did not work")})}),this.restartRefreshTimerIfStillLoggedIn()},r.prototype.refreshInternal=function(e,t){return"code"===this.responseType?this.refreshToken():this.silentRefresh(e,t)},r.prototype.loadDiscoveryDocumentAndTryLogin=function(e){var t=this;return void 0===e&&(e=null),this.loadDiscoveryDocument().then(function(r){return t.tryLogin(e)})},r.prototype.loadDiscoveryDocumentAndLogin=function(e){var t=this;return void 0===e&&(e=null),this.loadDiscoveryDocumentAndTryLogin(e).then(function(e){return!(!t.hasValidIdToken()||!t.hasValidAccessToken())||(t.initImplicitFlow(),!1)})},r.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.showDebugInformation&&this.logger.debug.apply(console,e)},r.prototype.validateUrlFromDiscoveryDocument=function(e){var t=[],r=this.validateUrlForHttps(e),n=this.validateUrlAgainstIssuer(e);return r||t.push("https for all urls required. Also for urls received by discovery."),n||t.push("Every url in discovery document has to start with the issuer url.Also see property strictDiscoveryDocumentValidation."),t},r.prototype.validateUrlForHttps=function(e){if(!e)return!0;var t=e.toLowerCase();return!1===this.requireHttps||(!(!t.match(/^http:\/\/localhost($|[:\/])/)&&!t.match(/^http:\/\/localhost($|[:\/])/)||"remoteOnly"!==this.requireHttps)||t.startsWith("https://"))},r.prototype.validateUrlAgainstIssuer=function(e){return!this.strictDiscoveryDocumentValidation||(!e||e.toLowerCase().startsWith(this.issuer.toLowerCase()))},r.prototype.setupRefreshTimer=function(){var e=this;"undefined"!=typeof window?(this.hasValidIdToken()&&(this.clearAccessTokenTimer(),this.clearIdTokenTimer(),this.setupExpirationTimers()),this.events.pipe(i.filter(function(e){return"token_received"===e.type})).subscribe(function(t){e.clearAccessTokenTimer(),e.clearIdTokenTimer(),e.setupExpirationTimers()})):this.debug("timer not supported on this plattform")},r.prototype.setupExpirationTimers=function(){var e=this.getIdTokenExpiration()||Number.MAX_VALUE,t=(this.getAccessTokenExpiration()||Number.MAX_VALUE)<=e;this.hasValidAccessToken()&&t&&this.setupAccessTokenTimer(),this.hasValidIdToken()&&!t&&this.setupIdTokenTimer()},r.prototype.setupAccessTokenTimer=function(){var e=this,t=this.getAccessTokenExpiration(),r=this.getAccessTokenStoredAt(),n=this.calcTimeout(r,t);this.ngZone.runOutsideAngular(function(){e.accessTokenTimeoutSubscription=o.of(new T("token_expires","access_token")).pipe(i.delay(n)).subscribe(function(t){e.ngZone.run(function(){e.eventsSubject.next(t)})})})},r.prototype.setupIdTokenTimer=function(){var e=this,t=this.getIdTokenExpiration(),r=this.getIdTokenStoredAt(),n=this.calcTimeout(r,t);this.ngZone.runOutsideAngular(function(){e.idTokenTimeoutSubscription=o.of(new T("token_expires","id_token")).pipe(i.delay(n)).subscribe(function(t){e.ngZone.run(function(){e.eventsSubject.next(t)})})})},r.prototype.clearAccessTokenTimer=function(){this.accessTokenTimeoutSubscription&&this.accessTokenTimeoutSubscription.unsubscribe()},r.prototype.clearIdTokenTimer=function(){this.idTokenTimeoutSubscription&&this.idTokenTimeoutSubscription.unsubscribe()},r.prototype.calcTimeout=function(e,t){var r=Date.now(),n=(t-e)*this.timeoutFactor-(r-e);return Math.max(0,n)},r.prototype.setStorage=function(e){this._storage=e,this.configChanged()},r.prototype.loadDiscoveryDocument=function(e){var t=this;return void 0===e&&(e=null),new Promise(function(r,n){e||((e=t.issuer||"").endsWith("/")||(e+="/"),e+=".well-known/openid-configuration"),t.validateUrlForHttps(e)?t.http.get(e).subscribe(function(e){if(!t.validateDiscoveryDocument(e))return t.eventsSubject.next(new I("discovery_document_validation_error",null)),void n("discovery_document_validation_error");t.loginUrl=e.authorization_endpoint,t.logoutUrl=e.end_session_endpoint||t.logoutUrl,t.grantTypesSupported=e.grant_types_supported,t.issuer=e.issuer,t.tokenEndpoint=e.token_endpoint,t.userinfoEndpoint=e.userinfo_endpoint,t.jwksUri=e.jwks_uri,t.sessionCheckIFrameUrl=e.check_session_iframe||t.sessionCheckIFrameUrl,t.discoveryDocumentLoaded=!0,t.discoveryDocumentLoadedSubject.next(e),t.sessionChecksEnabled&&t.restartSessionChecksIfStillLoggedIn(),t.loadJwks().then(function(n){var o=new S("discovery_document_loaded",{discoveryDocument:e,jwks:n});t.eventsSubject.next(o),r(o)})["catch"](function(e){t.eventsSubject.next(new I("discovery_document_load_error",e)),n(e)})},function(e){t.logger.error("error loading discovery document",e),t.eventsSubject.next(new I("discovery_document_load_error",e)),n(e)}):n("issuer must use https, or config value for property requireHttps must allow http")})},r.prototype.loadJwks=function(){var e=this;return new Promise(function(t,r){e.jwksUri?e.http.get(e.jwksUri).subscribe(function(r){e.jwks=r,e.eventsSubject.next(new S("discovery_document_loaded")),t(r)},function(t){e.logger.error("error loading jwks",t),e.eventsSubject.next(new I("jwks_load_error",t)),r(t)}):t(null)})},r.prototype.validateDiscoveryDocument=function(e){var t;return this.skipIssuerCheck||e.issuer===this.issuer?(t=this.validateUrlFromDiscoveryDocument(e.authorization_endpoint)).length>0?(this.logger.error("error validating authorization_endpoint in discovery document",t),!1):(t=this.validateUrlFromDiscoveryDocument(e.end_session_endpoint)).length>0?(this.logger.error("error validating end_session_endpoint in discovery document",t),!1):((t=this.validateUrlFromDiscoveryDocument(e.token_endpoint)).length>0&&this.logger.error("error validating token_endpoint in discovery document",t),(t=this.validateUrlFromDiscoveryDocument(e.userinfo_endpoint)).length>0?(this.logger.error("error validating userinfo_endpoint in discovery document",t),!1):(t=this.validateUrlFromDiscoveryDocument(e.jwks_uri)).length>0?(this.logger.error("error validating jwks_uri in discovery document",t),!1):(this.sessionChecksEnabled&&!e.check_session_iframe&&this.logger.warn("sessionChecksEnabled is activated but discovery document does not contain a check_session_iframe field"),!0)):(this.logger.error("invalid issuer in discovery document","expected: "+this.issuer,"current: "+e.issuer),!1)},r.prototype.fetchTokenUsingPasswordFlowAndLoadUserProfile=function(e,t,r){var o=this;return void 0===r&&(r=new n.HttpHeaders),this.fetchTokenUsingPasswordFlow(e,t,r).then(function(){return o.loadUserProfile()})},r.prototype.loadUserProfile=function(){var e=this;if(!this.hasValidAccessToken())throw new Error("Can not load User Profile without access_token");if(!this.validateUrlForHttps(this.userinfoEndpoint))throw new Error("userinfoEndpoint must use https, or config value for property requireHttps must allow http");return new Promise(function(t,r){var o=(new n.HttpHeaders).set("Authorization","Bearer "+e.getAccessToken());e.http.get(e.userinfoEndpoint,{headers:o}).subscribe(function(n){e.debug("userinfo received",n);var o=e.getIdentityClaims()||{};if(e.skipSubjectCheck||!e.oidc||o.sub&&n.sub===o.sub)n=Object.assign({},o,n),e._storage.setItem("id_token_claims_obj",JSON.stringify(n)),e.eventsSubject.next(new S("user_profile_loaded")),t(n);else{r("if property oidc is true, the received user-id (sub) has to be the user-id of the user that has logged in with oidc.\nif you are not using oidc but just oauth2 password flow set oidc to false")}},function(t){e.logger.error("error loading user info",t),e.eventsSubject.next(new I("user_profile_load_error",t)),r(t)})})},r.prototype.fetchTokenUsingPasswordFlow=function(e,t,r){var o=this;if(void 0===r&&(r=new n.HttpHeaders),!this.validateUrlForHttps(this.tokenEndpoint))throw new Error("tokenEndpoint must use https, or config value for property requireHttps must allow http");return new Promise(function(i,s){var a,c,u=new n.HttpParams({encoder:new A}).set("grant_type","password").set("scope",o.scope).set("username",e).set("password",t);if(o.useHttpBasicAuth){var h=btoa(o.clientId+":"+o.dummyClientSecret);r=r.set("Authorization","Basic "+h)}if(o.useHttpBasicAuth||(u=u.set("client_id",o.clientId)),!o.useHttpBasicAuth&&o.dummyClientSecret&&(u=u.set("client_secret",o.dummyClientSecret)),o.customQueryParams)try{for(var d=l(Object.getOwnPropertyNames(o.customQueryParams)),p=d.next();!p.done;p=d.next()){var f=p.value;u=u.set(f,o.customQueryParams[f])}}catch(g){a={error:g}}finally{try{p&&!p.done&&(c=d["return"])&&c.call(d)}finally{if(a)throw a.error}}r=r.set("Content-Type","application/x-www-form-urlencoded"),o.http.post(o.tokenEndpoint,u,{headers:r}).subscribe(function(e){o.debug("tokenResponse",e),o.storeAccessTokenResponse(e.access_token,e.refresh_token,e.expires_in,e.scope),o.eventsSubject.next(new S("token_received")),i(e)},function(e){o.logger.error("Error performing password flow",e),o.eventsSubject.next(new I("token_error",e)),s(e)})})},r.prototype.refreshToken=function(){var e=this;if(!this.validateUrlForHttps(this.tokenEndpoint))throw new Error("tokenEndpoint must use https, or config value for property requireHttps must allow http");return new Promise(function(t,r){var s,a,c=(new n.HttpParams).set("grant_type","refresh_token").set("client_id",e.clientId).set("scope",e.scope).set("refresh_token",e._storage.getItem("refresh_token"));if(e.dummyClientSecret&&(c=c.set("client_secret",e.dummyClientSecret)),e.customQueryParams)try{for(var u=l(Object.getOwnPropertyNames(e.customQueryParams)),h=u.next();!h.done;h=u.next()){var d=h.value;c=c.set(d,e.customQueryParams[d])}}catch(f){s={error:f}}finally{try{h&&!h.done&&(a=u["return"])&&a.call(u)}finally{if(s)throw s.error}}var p=(new n.HttpHeaders).set("Content-Type","application/x-www-form-urlencoded");e.http.post(e.tokenEndpoint,c,{headers:p}).pipe(i.switchMap(function(t){return t.id_token?o.from(e.processIdToken(t.id_token,t.access_token,!0)).pipe(i.tap(function(t){return e.storeIdToken(t)}),i.map(function(e){return t})):o.of(t)})).subscribe(function(r){e.debug("refresh tokenResponse",r),e.storeAccessTokenResponse(r.access_token,r.refresh_token,r.expires_in,r.scope),e.eventsSubject.next(new S("token_received")),e.eventsSubject.next(new S("token_refreshed")),t(r)},function(t){e.logger.error("Error performing password flow",t),e.eventsSubject.next(new I("token_refresh_error",t)),r(t)})})},r.prototype.removeSilentRefreshEventListener=function(){this.silentRefreshPostMessageEventListener&&(window.removeEventListener("message",this.silentRefreshPostMessageEventListener),this.silentRefreshPostMessageEventListener=null)},r.prototype.setupSilentRefreshEventListener=function(){var e=this;this.removeSilentRefreshEventListener(),this.silentRefreshPostMessageEventListener=function(t){var r=e.processMessageEventMessage(t);e.tryLogin({customHashFragment:r,preventClearHashAfterLogin:!0,onLoginError:function(t){e.eventsSubject.next(new I("silent_refresh_error",t))},onTokenReceived:function(){e.eventsSubject.next(new S("silently_refreshed"))}})["catch"](function(t){return e.debug("tryLogin during silent refresh failed",t)})},window.addEventListener("message",this.silentRefreshPostMessageEventListener)},r.prototype.silentRefresh=function(e,t){var r=this;void 0===e&&(e={}),void 0===t&&(t=!0);var n=this.getIdentityClaims()||{};if(this.useIdTokenHintForSilentRefresh&&this.hasValidIdToken()&&(e.id_token_hint=this.getIdToken()),!this.validateUrlForHttps(this.loginUrl))throw new Error("tokenEndpoint must use https, or config value for property requireHttps must allow http");if("undefined"==typeof document)throw new Error("silent refresh is not supported on this platform");var s=document.getElementById(this.silentRefreshIFrameName);s&&document.body.removeChild(s),this.silentRefreshSubject=n.sub;var a=document.createElement("iframe");a.id=this.silentRefreshIFrameName,this.setupSilentRefreshEventListener();var c=this.silentRefreshRedirectUri||this.redirectUri;this.createLoginUrl(null,null,c,t,e).then(function(e){a.setAttribute("src",e),r.silentRefreshShowIFrame||(a.style.display="none"),document.body.appendChild(a)});var u=this.events.pipe(i.filter(function(e){return e instanceof I}),i.first()),h=this.events.pipe(i.filter(function(e){return"silently_refreshed"===e.type}),i.first()),l=o.of(new I("silent_refresh_timeout",null)).pipe(i.delay(this.silentRefreshTimeout));return o.race([u,h,l]).pipe(i.tap(function(e){"silent_refresh_timeout"===e.type&&r.eventsSubject.next(e)}),i.map(function(e){if(e instanceof I)throw e;return e})).toPromise()},r.prototype.initImplicitFlowInPopup=function(e){var t=this;return e=e||{},this.createLoginUrl(null,null,this.silentRefreshRedirectUri,!1,{display:"popup"}).then(function(r){return new Promise(function(n,o){var i=window.open(r,"_blank",t.calculatePopupFeatures(e)),s=function(){window.removeEventListener("message",a),i.close(),i=null},a=function(e){var r=t.processMessageEventMessage(e);t.tryLogin({customHashFragment:r,preventClearHashAfterLogin:!0}).then(function(){s(),n()},function(e){s(),o(e)})};window.addEventListener("message",a)})})},r.prototype.calculatePopupFeatures=function(e){var t=e.height||470,r=e.width||500,n=screen.width/2-r/2;return"location=no,toolbar=no,width="+r+",height="+t+",top="+(screen.height/2-t/2)+",left="+n},r.prototype.processMessageEventMessage=function(e){var t="#";if(this.silentRefreshMessagePrefix&&(t+=this.silentRefreshMessagePrefix),e&&e.data&&"string"==typeof e.data){var r=e.data;if(r.startsWith(t))return"#"+r.substr(t.length)}},r.prototype.canPerformSessionCheck=function(){return!!this.sessionChecksEnabled&&(this.sessionCheckIFrameUrl?this.getSessionState()?"undefined"!=typeof document:(console.warn("sessionChecksEnabled is activated but there is no session_state"),!1):(console.warn("sessionChecksEnabled is activated but there is no sessionCheckIFrameUrl"),!1))},r.prototype.setupSessionCheckEventListener=function(){var e=this;this.removeSessionCheckEventListener(),this.sessionCheckEventListener=function(t){var r=t.origin.toLowerCase(),n=e.issuer.toLowerCase();switch(e.debug("sessionCheckEventListener"),n.startsWith(r)||e.debug("sessionCheckEventListener","wrong origin",r,"expected",n),t.data){case"unchanged":e.handleSessionUnchanged();break;case"changed":e.ngZone.run(function(){e.handleSessionChange()});break;case"error":e.ngZone.run(function(){e.handleSessionError()})}e.debug("got info from session check inframe",t)},this.ngZone.runOutsideAngular(function(){window.addEventListener("message",e.sessionCheckEventListener)})},r.prototype.handleSessionUnchanged=function(){this.debug("session check","session unchanged")},r.prototype.handleSessionChange=function(){var e=this;this.eventsSubject.next(new T("session_changed")),this.stopSessionCheckTimer(),this.silentRefreshRedirectUri?(this.silentRefresh()["catch"](function(t){return e.debug("silent refresh failed after session changed")}),this.waitForSilentRefreshAfterSessionChange()):(this.eventsSubject.next(new T("session_terminated")),this.logOut(!0))},r.prototype.waitForSilentRefreshAfterSessionChange=function(){var e=this;this.events.pipe(i.filter(function(e){return"silently_refreshed"===e.type||"silent_refresh_timeout"===e.type||"silent_refresh_error"===e.type}),i.first()).subscribe(function(t){"silently_refreshed"!==t.type&&(e.debug("silent refresh did not work after session changed"),e.eventsSubject.next(new T("session_terminated")),e.logOut(!0))})},r.prototype.handleSessionError=function(){this.stopSessionCheckTimer(),this.eventsSubject.next(new T("session_error"))},r.prototype.removeSessionCheckEventListener=function(){this.sessionCheckEventListener&&(window.removeEventListener("message",this.sessionCheckEventListener),this.sessionCheckEventListener=null)},r.prototype.initSessionCheck=function(){if(this.canPerformSessionCheck()){var e=document.getElementById(this.sessionCheckIFrameName);e&&document.body.removeChild(e);var t=document.createElement("iframe");t.id=this.sessionCheckIFrameName,this.setupSessionCheckEventListener();var r=this.sessionCheckIFrameUrl;t.setAttribute("src",r),t.style.display="none",document.body.appendChild(t),this.startSessionCheckTimer()}},r.prototype.startSessionCheckTimer=function(){var e=this;this.stopSessionCheckTimer(),this.ngZone.runOutsideAngular(function(){e.sessionCheckTimer=setInterval(e.checkSession.bind(e),e.sessionCheckIntervall)})},r.prototype.stopSessionCheckTimer=function(){this.sessionCheckTimer&&(clearInterval(this.sessionCheckTimer),this.sessionCheckTimer=null)},r.prototype.checkSession=function(){var e=document.getElementById(this.sessionCheckIFrameName);e||this.logger.warn("checkSession did not find iframe",this.sessionCheckIFrameName);var t=this.getSessionState();t||this.stopSessionCheckTimer();var r=this.clientId+" "+t;e.contentWindow.postMessage(r,this.issuer)},r.prototype.createLoginUrl=function(e,t,r,n,o){return void 0===e&&(e=""),void 0===t&&(t=""),void 0===r&&(r=""),void 0===n&&(n=!1),void 0===o&&(o={}),u(this,void 0,void 0,function(){var i,s,a,c,u,p,f,g,m,v,y,k,_,w,b,S,T,I;return h(this,function(h){switch(h.label){case 0:return u=this,p=r||this.redirectUri,[4,this.createAndSaveNonce()];case 1:if(f=h.sent(),e=e?f+this.config.nonceStateSeparator+e:f,!this.requestAccessToken&&!this.oidc)throw new Error("Either requestAccessToken or oidc or both must be true");return this.config.responseType?this.responseType=this.config.responseType:this.oidc&&this.requestAccessToken?this.responseType="id_token token":this.oidc&&!this.requestAccessToken?this.responseType="id_token":this.responseType="token",g=u.loginUrl.indexOf("?")>-1?"&":"?",m=u.scope,this.oidc&&!m.match(/(^|\s)openid($|\s)/)&&(m="openid "+m),v=u.loginUrl+g+"response_type="+encodeURIComponent(u.responseType)+"&client_id="+encodeURIComponent(u.clientId)+"&state="+encodeURIComponent(e)+"&redirect_uri="+encodeURIComponent(p)+"&scope="+encodeURIComponent(m),"code"!==this.responseType||this.disablePKCE?[3,3]:[4,this.createChallangeVerifierPairForPKCE()];case 2:y=d.apply(void 0,[h.sent(),2]),k=y[0],_=y[1],this._storage.setItem("PKCI_verifier",_),v+="&code_challenge="+k,v+="&code_challenge_method=S256",h.label=3;case 3:t&&(v+="&login_hint="+encodeURIComponent(t)),u.resource&&(v+="&resource="+encodeURIComponent(u.resource)),u.oidc&&(v+="&nonce="+encodeURIComponent(f)),n&&(v+="&prompt=none");try{for(w=l(Object.keys(o)),b=w.next();!b.done;b=w.next())I=b.value,v+="&"+encodeURIComponent(I)+"="+encodeURIComponent(o[I])}catch(C){i={error:C}}finally{try{b&&!b.done&&(s=w["return"])&&s.call(w)}finally{if(i)throw i.error}}if(this.customQueryParams)try{for(S=l(Object.getOwnPropertyNames(this.customQueryParams)),T=S.next();!T.done;T=S.next())I=T.value,v+="&"+I+"="+encodeURIComponent(this.customQueryParams[I])}catch(A){a={error:A}}finally{try{T&&!T.done&&(c=S["return"])&&c.call(S)}finally{if(a)throw a.error}}return[2,v]}})})},r.prototype.initImplicitFlowInternal=function(e,t){var r=this;if(void 0===e&&(e=""),void 0===t&&(t=""),!this.inImplicitFlow){if(this.inImplicitFlow=!0,!this.validateUrlForHttps(this.loginUrl))throw new Error("loginUrl must use https, or config value for property requireHttps must allow http");var n={},o=null;"string"==typeof t?o=t:"object"==typeof t&&(n=t),this.createLoginUrl(e,o,null,!1,n).then(this.config.openUri)["catch"](function(e){console.error("Error in initImplicitFlow",e),r.inImplicitFlow=!1})}},r.prototype.initImplicitFlow=function(e,t){var r=this;void 0===e&&(e=""),void 0===t&&(t=""),""!==this.loginUrl?this.initImplicitFlowInternal(e,t):this.events.pipe(i.filter(function(e){return"discovery_document_loaded"===e.type})).subscribe(function(n){return r.initImplicitFlowInternal(e,t)})},r.prototype.resetImplicitFlow=function(){this.inImplicitFlow=!1},r.prototype.callOnTokenReceivedIfExists=function(e){if(e.onTokenReceived){var t={idClaims:this.getIdentityClaims(),idToken:this.getIdToken(),accessToken:this.getAccessToken(),state:this.state};e.onTokenReceived(t)}},r.prototype.storeAccessTokenResponse=function(e,t,r,n){if(this._storage.setItem("access_token",e),n&&this._storage.setItem("granted_scopes",JSON.stringify(n.split("+"))),this._storage.setItem("access_token_stored_at",""+Date.now()),r){var o=1e3*r,i=(new Date).getTime()+o;this._storage.setItem("expires_at",""+i)}t&&this._storage.setItem("refresh_token",t)},r.prototype.tryLogin=function(e){return void 0===e&&(e=null),"code"===this.config.responseType?this.tryLoginCodeFlow().then(function(e){return!0}):this.tryLoginImplicitFlow(e)},r.prototype.parseQueryString=function(e){return e&&0!==e.length?("?"===e.charAt(0)&&(e=e.substr(1)),this.urlHelper.parseQueryString(e)):{}},r.prototype.tryLoginCodeFlow=function(){var e=this,t=this.parseQueryString(window.location.search),r=t.code,n=t.state,o=location.href.replace(/[&\?]code=[^&\$]*/,"").replace(/[&\?]scope=[^&\$]*/,"").replace(/[&\?]state=[^&\$]*/,"").replace(/[&\?]session_state=[^&\$]*/,"");history.replaceState(null,window.name,o);var i=d(this.parseState(n),2),s=i[0],a=i[1];if(this.state=a,t.error){this.debug("error trying to login"),this.handleLoginError({},t);var c=new I("code_error",{},t);return this.eventsSubject.next(c),Promise.reject(c)}if(!s)return Promise.resolve();if(!this.validateNonce(s)){var u=new I("invalid_nonce_in_state",null);return this.eventsSubject.next(u),Promise.reject(u)}return r?new Promise(function(t,n){e.getTokenFromCode(r).then(function(e){t()})["catch"](function(e){n(e)})}):Promise.resolve()},r.prototype.getTokenFromCode=function(e){var t=(new n.HttpParams).set("grant_type","authorization_code").set("code",e).set("redirect_uri",this.redirectUri);if(!this.disablePKCE){var r=this._storage.getItem("PKCI_verifier");r?t=t.set("code_verifier",r):console.warn("No PKCI verifier found in oauth storage!")}return this.fetchAndProcessToken(t)},r.prototype.fetchAndProcessToken=function(e){var t=this,r=(new n.HttpHeaders).set("Content-Type","application/x-www-form-urlencoded");if(!this.validateUrlForHttps(this.tokenEndpoint))throw new Error("tokenEndpoint must use Http. Also check property requireHttps.");if(this.useHttpBasicAuth){var o=btoa(this.clientId+":"+this.dummyClientSecret);r=r.set("Authorization","Basic "+o)}return this.useHttpBasicAuth||(e=e.set("client_id",this.clientId)),!this.useHttpBasicAuth&&this.dummyClientSecret&&(e=e.set("client_secret",this.dummyClientSecret)),new Promise(function(n,o){var i,s;if(t.customQueryParams)try{for(var a=l(Object.getOwnPropertyNames(t.customQueryParams)),c=a.next();!c.done;c=a.next()){var u=c.value;e=e.set(u,t.customQueryParams[u])}}catch(h){i={error:h}}finally{try{c&&!c.done&&(s=a["return"])&&s.call(a)}finally{if(i)throw i.error}}t.http.post(t.tokenEndpoint,e,{headers:r}).subscribe(function(e){t.debug("refresh tokenResponse",e),t.storeAccessTokenResponse(e.access_token,e.refresh_token,e.expires_in,e.scope),t.oidc&&e.id_token?t.processIdToken(e.id_token,e.access_token).then(function(r){t.storeIdToken(r),t.eventsSubject.next(new S("token_received")),t.eventsSubject.next(new S("token_refreshed")),n(e)})["catch"](function(e){t.eventsSubject.next(new I("token_validation_error",e)),console.error("Error validating tokens"),console.error(e),o(e)}):(t.eventsSubject.next(new S("token_received")),t.eventsSubject.next(new S("token_refreshed")),n(e))},function(e){console.error("Error getting token",e),t.eventsSubject.next(new I("token_refresh_error",e)),o(e)})})},r.prototype.tryLoginImplicitFlow=function(e){var t,r=this;void 0===e&&(e=null),t=(e=e||{}).customHashFragment?this.urlHelper.getHashFragmentParams(e.customHashFragment):this.urlHelper.getHashFragmentParams(),this.debug("parsed url",t);var n=t.state,o=d(this.parseState(n),2),i=o[0],s=o[1];if(this.state=s,t.error){this.debug("error trying to login"),this.handleLoginError(e,t);var a=new I("token_error",{},t);return this.eventsSubject.next(a),Promise.reject(a)}var c=t.access_token,u=t.id_token,h=t.session_state,l=t.scope;if(!this.requestAccessToken&&!this.oidc)return Promise.reject("Either requestAccessToken or oidc (or both) must be true.");if(this.requestAccessToken&&!c)return Promise.resolve(!1);if(this.requestAccessToken&&!e.disableOAuth2StateCheck&&!n)return Promise.resolve(!1);if(this.oidc&&!u)return Promise.resolve(!1);if((this.sessionChecksEnabled&&!h&&this.logger.warn("session checks (Session Status Change Notification) were activated in the configuration but the id_token does not contain a session_state claim"),this.requestAccessToken&&!e.disableOAuth2StateCheck)&&!this.validateNonce(i)){var p=new I("invalid_nonce_in_state",null);return this.eventsSubject.next(p),Promise.reject(p)}return this.requestAccessToken&&this.storeAccessTokenResponse(c,null,t.expires_in||this.fallbackAccessTokenExpirationTimeInSec,l),this.oidc?this.processIdToken(u,c).then(function(t){return e.validationHandler?e.validationHandler({accessToken:c,idClaims:t.idTokenClaims,idToken:t.idToken,state:n}).then(function(e){return t}):t}).then(function(t){return r.storeIdToken(t),r.storeSessionState(h),r.clearHashAfterLogin&&(location.hash=""),r.eventsSubject.next(new S("token_received")),r.callOnTokenReceivedIfExists(e),r.inImplicitFlow=!1,!0})["catch"](function(e){return r.eventsSubject.next(new I("token_validation_error",e)),r.logger.error("Error validating tokens"),r.logger.error(e),Promise.reject(e)}):(this.eventsSubject.next(new S("token_received")),this.clearHashAfterLogin&&!e.preventClearHashAfterLogin&&(location.hash=""),this.callOnTokenReceivedIfExists(e),Promise.resolve(!0))},r.prototype.parseState=function(e){var t=e,r="";if(e){var n=e.indexOf(this.config.nonceStateSeparator);n>-1&&(t=e.substr(0,n),r=e.substr(n+this.config.nonceStateSeparator.length))}return[t,r]},r.prototype.validateNonce=function(e){var t=this._storage.getItem("nonce");if(t!==e){return console.error("Validating access_token failed, wrong state/nonce.",t,e),!1}return!0},r.prototype.storeIdToken=function(e){this._storage.setItem("id_token",e.idToken),this._storage.setItem("id_token_claims_obj",e.idTokenClaimsJson),this._storage.setItem("id_token_expires_at",""+e.idTokenExpiresAt),this._storage.setItem("id_token_stored_at",""+Date.now())},r.prototype.storeSessionState=function(e){this._storage.setItem("session_state",e)},r.prototype.getSessionState=function(){return this._storage.getItem("session_state")},r.prototype.handleLoginError=function(e,t){e.onLoginError&&e.onLoginError(t),this.clearHashAfterLogin&&(location.hash="")},r.prototype.processIdToken=function(e,t,r){var n=this;void 0===r&&(r=!1);var o=e.split("."),i=v(this.padBase64(o[0])),s=JSON.parse(i),a=v(this.padBase64(o[1])),c=JSON.parse(a),u=this._storage.getItem("nonce");if(Array.isArray(c.aud)){if(c.aud.every(function(e){return e!==n.clientId})){var h="Wrong audience: "+c.aud.join(",");return this.logger.warn(h),Promise.reject(h)}}else if(c.aud!==this.clientId){h="Wrong audience: "+c.aud;return this.logger.warn(h),Promise.reject(h)}if(!c.sub){h="No sub claim in id_token";return this.logger.warn(h),Promise.reject(h)}if(this.sessionChecksEnabled&&this.silentRefreshSubject&&this.silentRefreshSubject!==c.sub){h="After refreshing, we got an id_token for another user (sub). Expected sub: "+this.silentRefreshSubject+", received sub: "+c.sub;return this.logger.warn(h),Promise.reject(h)}if(!c.iat){h="No iat claim in id_token";return this.logger.warn(h),Promise.reject(h)}if(!this.skipIssuerCheck&&c.iss!==this.issuer){h="Wrong issuer: "+c.iss;return this.logger.warn(h),Promise.reject(h)}if(!r&&c.nonce!==u){h="Wrong nonce: "+c.nonce;return this.logger.warn(h),Promise.reject(h)}if(!this.disableAtHashCheck&&this.requestAccessToken&&!c.at_hash){h="An at_hash is needed!";return this.logger.warn(h),Promise.reject(h)}var l=Date.now(),d=1e3*c.iat,p=1e3*c.exp,f=1e3*(this.clockSkewInSec||600);if(d-f>=l||p+f<=l){h="Token has expired";return console.error(h),console.error({now:l,issuedAtMSec:d,expiresAtMSec:p}),Promise.reject(h)}var g={accessToken:t,idToken:e,jwks:this.jwks,idTokenClaims:c,idTokenHeader:s,loadKeys:function(){return n.loadJwks()}};return this.checkAtHash(g).then(function(t){if(!n.disableAtHashCheck&&n.requestAccessToken&&!t){var r="Wrong at_hash";return n.logger.warn(r),Promise.reject(r)}return n.checkSignature(g).then(function(t){return{idToken:e,idTokenClaims:c,idTokenClaimsJson:a,idTokenHeader:s,idTokenHeaderJson:i,idTokenExpiresAt:p}})})},r.prototype.getIdentityClaims=function(){var e=this._storage.getItem("id_token_claims_obj");return e?JSON.parse(e):null},r.prototype.getGrantedScopes=function(){var e=this._storage.getItem("granted_scopes");return e?JSON.parse(e):null},r.prototype.getIdToken=function(){return this._storage?this._storage.getItem("id_token"):null},r.prototype.padBase64=function(e){for(;e.length%4!=0;)e+="=";return e},r.prototype.getAccessToken=function(){return this._storage?this._storage.getItem("access_token"):null},r.prototype.getRefreshToken=function(){return this._storage?this._storage.getItem("refresh_token"):null},r.prototype.getAccessTokenExpiration=function(){return this._storage.getItem("expires_at")?parseInt(this._storage.getItem("expires_at"),10):null},r.prototype.getAccessTokenStoredAt=function(){return parseInt(this._storage.getItem("access_token_stored_at"),10)},r.prototype.getIdTokenStoredAt=function(){return parseInt(this._storage.getItem("id_token_stored_at"),10)},r.prototype.getIdTokenExpiration=function(){return this._storage.getItem("id_token_expires_at")?parseInt(this._storage.getItem("id_token_expires_at"),10):null},r.prototype.hasValidAccessToken=function(){if(this.getAccessToken()){var e=this._storage.getItem("expires_at"),t=new Date;return!(e&&parseInt(e,10)<t.getTime())}return!1},r.prototype.hasValidIdToken=function(){if(this.getIdToken()){var e=this._storage.getItem("id_token_expires_at"),t=new Date;return!(e&&parseInt(e,10)<t.getTime())}return!1},r.prototype.authorizationHeader=function(){return"Bearer "+this.getAccessToken()},r.prototype.logOut=function(e){void 0===e&&(e=!1);var t=this.getIdToken();if(this._storage.removeItem("access_token"),this._storage.removeItem("id_token"),this._storage.removeItem("refresh_token"),this._storage.removeItem("nonce"),this._storage.removeItem("expires_at"),this._storage.removeItem("id_token_claims_obj"),this._storage.removeItem("id_token_expires_at"),this._storage.removeItem("id_token_stored_at"),this._storage.removeItem("access_token_stored_at"),this._storage.removeItem("granted_scopes"),this._storage.removeItem("session_state"),this.silentRefreshSubject=null,this.eventsSubject.next(new T("logout")),this.logoutUrl&&!e&&(t||this.postLogoutRedirectUri)){var r;if(!this.validateUrlForHttps(this.logoutUrl))throw new Error("logoutUrl must use https, or config value for property requireHttps must allow http");if(this.logoutUrl.indexOf("{{")>-1)r=this.logoutUrl.replace(/\{\{id_token\}\}/,t).replace(/\{\{client_id\}\}/,this.clientId);else{var o=new n.HttpParams;t&&(o=o.set("id_token_hint",t));var i=this.postLogoutRedirectUri||this.redirectUri;i&&(o=o.set("post_logout_redirect_uri",i)),r=this.logoutUrl+(this.logoutUrl.indexOf("?")>-1?"&":"?")+o.toString()}this.config.openUri(r)}},r.prototype.createAndSaveNonce=function(){var e=this;return this.createNonce().then(function(t){return e._storage.setItem("nonce",t),t})},r.prototype.ngOnDestroy=function(){this.clearAccessTokenTimer(),this.clearIdTokenTimer()},r.prototype.createNonce=function(){var e=this;return new Promise(function(t){if(e.rngUrl)throw new Error("createNonce with rng-web-api has not been implemented so far");var r="Uint8ArdomValuesObj012345679BCDEFGHIJKLMNPQRSTWXYZ_cfghkpqvwxyz-",n=45,o="",i=self.crypto||self.msCrypto;if(i)for(var s=i.getRandomValues(new Uint8Array(n));0<n--;)o+=r[63&s[n]];else for(;0<n--;)o+=r[64*Math.random()|0];t(o)})},r.prototype.checkAtHash=function(e){return u(this,void 0,void 0,function(){return h(this,function(t){return this.tokenValidationHandler?[2,this.tokenValidationHandler.validateAtHash(e)]:(this.logger.warn("No tokenValidationHandler configured. Cannot check at_hash."),[2,!0])})})},r.prototype.checkSignature=function(e){return this.tokenValidationHandler?this.tokenValidationHandler.validateSignature(e):(this.logger.warn("No tokenValidationHandler configured. Cannot check signature."),Promise.resolve(null))},r.prototype.initLoginFlow=function(e,t){return void 0===e&&(e=""),void 0===t&&(t={}),"code"===this.responseType?this.initCodeFlow(e,t):this.initImplicitFlow(e,t)},r.prototype.initCodeFlow=function(e,t){var r=this;void 0===e&&(e=""),void 0===t&&(t={}),""!==this.loginUrl?this.initCodeFlowInternal(e,t):this.events.pipe(i.filter(function(e){return"discovery_document_loaded"===e.type})).subscribe(function(n){return r.initCodeFlowInternal(e,t)})},r.prototype.initCodeFlowInternal=function(e,t){if(void 0===e&&(e=""),void 0===t&&(t={}),!this.validateUrlForHttps(this.loginUrl))throw new Error("loginUrl must use Http. Also check property requireHttps.");this.createLoginUrl(e,"",null,!1,t).then(function(e){location.href=e})["catch"](function(e){console.error("Error in initAuthorizationCodeFlow"),console.error(e)})},r.prototype.createChallangeVerifierPairForPKCE=function(){return u(this,void 0,void 0,function(){var e,t;return h(this,function(r){switch(r.label){case 0:if(!this.crypto)throw new Error("PKCI support for code flow needs a CryptoHander. Did you import the OAuthModule using forRoot() ?");return[4,this.createNonce()];case 1:return e=r.sent(),[4,this.crypto.calcHash(e,"sha-256")];case 2:return t=r.sent(),[2,[y(t),e]]}})})},r.decorators=[{type:t.Injectable}],r.ctorParameters=function(){return[{type:t.NgZone},{type:n.HttpClient},{type:g,decorators:[{type:t.Optional}]},{type:k,decorators:[{type:t.Optional}]},{type:C,decorators:[{type:t.Optional}]},{type:w},{type:f},{type:E,decorators:[{type:t.Optional}]}]},r}(C),x=function(){return function(){}}(),H=function(){return function(){}}(),P=function(){return function(){}}(),U=function(){function e(){}return e.prototype.handleError=function(e){return o.throwError(e)},e}(),R=function(){function e(e,t,r,n){this.authStorage=e,this.oAuthService=t,this.errorHandler=r,this.moduleConfig=n}return e.prototype.checkUrl=function(e){return this.moduleConfig.resourceServer.customUrlValidation?this.moduleConfig.resourceServer.customUrlValidation(e):!this.moduleConfig.resourceServer.allowedUrls||!!this.moduleConfig.resourceServer.allowedUrls.find(function(t){return e.startsWith(t)})},e.prototype.intercept=function(e,t){var r=this,n=e.url.toLowerCase();return this.moduleConfig&&this.moduleConfig.resourceServer?this.moduleConfig.resourceServer.allowedUrls&&!this.checkUrl(n)?t.handle(e):this.moduleConfig.resourceServer.sendAccessToken?o.merge(o.of(this.oAuthService.getAccessToken()).pipe(i.filter(function(e){return!!e})),this.oAuthService.events.pipe(i.filter(function(e){return"token_received"===e.type}),i.timeout(1e3),i.map(function(e){return r.oAuthService.getAccessToken()}))).pipe(i.take(1),i.mergeMap(function(n){if(n){var o="Bearer "+n,s=e.headers.set("Authorization",o);e=e.clone({headers:s})}return t.handle(e).pipe(i.catchError(function(e){return r.errorHandler.handleError(e)}))})):t.handle(e).pipe(i.catchError(function(e){return r.errorHandler.handleError(e)})):t.handle(e)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:g},{type:j},{type:P},{type:x,decorators:[{type:t.Optional}]}]},e}(),F=function(){function e(){}return e.prototype.validateSignature=function(e){return Promise.resolve(null)},e.prototype.validateAtHash=function(e){return Promise.resolve(!0)},e}();function L(){return console}function O(){return"undefined"!=typeof sessionStorage?sessionStorage:null}var D=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.allowedAlgorithms=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","PS256","PS384","PS512"],t.gracePeriodInSec=600,t}return c(t,e),t.prototype.validateSignature=function(e,t){var r=this;if(void 0===t&&(t=!1),!e.idToken)throw new Error("Parameter idToken expected!");if(!e.idTokenHeader)throw new Error("Parameter idTokenHandler expected.");if(!e.jwks)throw new Error("Parameter jwks expected!");if(!e.jwks.keys||!Array.isArray(e.jwks.keys)||0===e.jwks.keys.length)throw new Error("Array keys in jwks missing!");var n,o=e.idTokenHeader.kid,i=e.jwks.keys,a=e.idTokenHeader.alg;if(o)n=i.find(function(e){return e.kid===o});else{var c=this.alg2kty(a),u=i.filter(function(e){return e.kty===c&&"sig"===e.use});if(u.length>1){var h="More than one matching key found. Please specify a kid in the id_token header.";return console.error(h),Promise.reject(h)}1===u.length&&(n=u[0])}if(!n&&!t&&e.loadKeys)return e.loadKeys().then(function(t){return e.jwks=t}).then(function(t){return r.validateSignature(e,!0)});if(!n&&t&&!o){h="No matching key found.";return console.error(h),Promise.reject(h)}if(!n&&t&&o){h="expected key not found in property jwks. This property is most likely loaded with the discovery document. Expected key id (kid): "+o;return console.error(h),Promise.reject(h)}var l=s.KEYUTIL.getKey(n),d={alg:this.allowedAlgorithms,gracePeriod:this.gracePeriodInSec};return s.KJUR.jws.JWS.verifyJWT(e.idToken,l,d)?Promise.resolve():Promise.reject("Signature not valid")},t.prototype.alg2kty=function(e){switch(e.charAt(0)){case"R":return"RSA";case"E":return"EC";default:throw new Error("Cannot infer kty from alg: "+e)}},t.prototype.calcHash=function(e,t){var r=new s.KJUR.crypto.MessageDigest({alg:t}).digestString(e),n=this.toByteArrayAsString(r);return Promise.resolve(n)},t.prototype.toByteArrayAsString=function(e){for(var t="",r=0;r<e.length;r+=2){var n=e.charAt(r)+e.charAt(r+1),o=parseInt(n,16);t+=String.fromCharCode(o)}return t},t}(_),N=function(){function e(){}return e.forRoot=function(t,r){return void 0===t&&(t=null),void 0===r&&(r=F),{ngModule:e,providers:[j,w,{provide:f,useFactory:L},{provide:g,useFactory:O},{provide:k,useClass:r},{provide:E,useClass:D},{provide:P,useClass:U},{provide:x,useValue:t},{provide:n.HTTP_INTERCEPTORS,useClass:R,multi:!0}]}},e.decorators=[{type:t.NgModule,args:[{imports:[r.CommonModule],declarations:[],exports:[]}]}],e}(),V=new t.InjectionToken("AUTH_CONFIG");e.AUTH_CONFIG=V,e.AbstractValidationHandler=_,e.AuthConfig=C,e.DefaultOAuthInterceptor=R,e.JwksValidationHandler=D,e.LoginOptions=p,e.NullValidationHandler=F,e.OAuthErrorEvent=I,e.OAuthEvent=b,e.OAuthInfoEvent=T,e.OAuthLogger=f,e.OAuthModule=N,e.OAuthModuleConfig=x,e.OAuthNoopResourceServerErrorHandler=U,e.OAuthResourceServerConfig=H,e.OAuthResourceServerErrorHandler=P,e.OAuthService=j,e.OAuthStorage=g,e.OAuthSuccessEvent=S,e.ReceivedTokens=m,e.UrlHelperService=w,e.ValidationHandler=k,e.ɵa=E,e.ɵb=L,e.ɵc=O,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=angular-oauth2-oidc.umd.min.js.map